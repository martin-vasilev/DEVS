---
title: "Sound stats"
author: "Martin R Vasilev"
date: "14 September 2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = getwd())
```


## Data pre-processing:

```{r, echo= FALSE}
source("https://raw.githubusercontent.com/martin-vasilev/R_scripts/master/useful_functions.R")
load("C:/Users/mvasilev/Documents/DEVS/preproc/sound_check.Rda")

nobs<- nrow(sound_check)

# remove blinks on critical words:
blinks<- which(sound_check$blink=='Yes')
nblinks<- length(blinks)
sound_check<- sound_check[-blinks,]


# remove sounds played after fixation has started:
infix<- which(sound_check$nextFlag=="EFIX" & sound_check$delFix>50)
infixn<- length(infix)
sound_check<- sound_check[-infix,]

#cat(sprintf("%d percent of data excluded due to blinks", (nblinks/nobs)*100))
#cat(sprintf("%d percent of data excluded due to in-fixations", (infixn/nobs)*100))
#cat(sprintf("%d percent of data remains for analysis", (nrow(sound_check)/nobs)*100))

sound_check<- subset(sound_check, delFix<80)


```
- based on `r length(unique(sound_check$sub))` unique subjects
- `r (nblinks/nobs)*100` % of data was excluded due to blinks on critical words
- `r (infixn/nobs)*100` % of data was excluded due to late triggering of the sound (command sent after start of fixation)
- `r (nrow(sound_check)/nobs)*100` % of data remains for analysis 

## Timing of sound:

Time in ms between sending the command to play sound and the end of the saccade that triggered the sound. Mean: `r mean(sound_check$delFix, na.rm=T)`. SD: `r sd(sound_check$delFix, na.rm=T)`. Range: `r range(sound_check$delFix, na.rm=T)`. 

Note that technology doesn't allow absolute time-locking to the onset of fixation. The reason for this is that Eyelink's algorithm for online parsing of fixations requires about 35 ms to obtain enough samples to detect the start of a fixation. Therefore, if you wait for this flag from the system, the fixation would have already started ~ 35 ms ago. This is clearly too much delay for the present study. The best approach (adopted here) is to trigger the sound as soon as the eye reaches the middle of the empty space before the word. Usually, this happens towards the end of the saccade. The data above show how many ms passed from triggering the sound to the start of the next fixation. 

The sound in this experiment requires 14 ms from sending the 'play' command to the signal coming out from the speakers. Since the command to play the sound is sent several ms before the start of fixation on the critical word, this means that participants will hear the sound within several ms after the start of fixation. In other words, the latency between the start of fixation on the critical word and participants hearing the sound is: 14 ms - time between sending the command and the start of fixation. The distribution of this latency is shown below:



```{r, echo= FALSE}
hist(14- sound_check$delFix, xlab= "Sound onset delay relative to fixation onset of the critical word", main= "Sound implementation timing", family= "serif", col="lightgreen", freq=FALSE, breaks=30)
abline(v = mean(sound_check$delFix, na.rm=T), col= "darkred", lwd=3)
curve(dnorm(x, mean=mean(14- sound_check$delFix, na.rm=T), sd=sd(14-sound_check$delFix, na.rm=T)), add=TRUE, col="darkblue", lwd=2) 

```

## Inter-stimulus Interval (ISI):

The pace of the sound presentation is determined by participants, in the sense that it depends on how long they fixate words in the sentence. For this reason, it's useful to know what is the average interval between playing two consequitive sounds. 

Mean: `r mean(sound_check$ISI, na.rm=T)`. SD: `r sd(sound_check$ISI, na.rm=T)`. Range: `r range(sound_check$ISI, na.rm=T)`. 

```{r, echo= FALSE}
hist(sound_check$ISI-50, xlab= "ISI between two consequitive sounds", main= "ISI timing", family= "serif", col="lightgreen", freq=FALSE, breaks=30)
abline(v = mean(sound_check$ISI-50, na.rm=T), col= "darkred", lwd=3)
curve(dnorm(x, mean=mean(sound_check$ISI-50, na.rm=T), sd=sd(sound_check$ISI-50, na.rm=T)), add=TRUE, col="darkblue", lwd=2) 

```


## Descriptive statistics:

### Fixation duration measures (on critical words):

```{r, echo=FALSE}
load("C:/Users/mvasilev/Documents/DEVS/data/FD.Rda")

load_package('reshape')
FD<- subset(FD,!is.na(sound))
FD$sound<- as.factor(FD$sound)

DesFix<- melt(FD, id=c('sub', 'item', 'cond', 'sound'), 
              measure=c("FFD", "GD", "TVT"), na.rm=TRUE)
mFix<- cast(DesFix, sound ~ variable
            , function(x) c(M=signif(mean(x),3)
                            , SD= sd(x) ))


load_package("ggplot2")

db<- data.frame(c(mFix$FFD_M, mFix$GD_M, mFix$TVT_M), c(mFix$FFD_SD, mFix$GD_SD, mFix$TVT_SD),
                c(rep("FFD",3),  rep("GD",3), rep("TVT",3)), 
                rep(c("Standard", "Deviant", "Silence"),3))

colnames(db)<- c("Mean", "SD", "Measure", "Sound")
db$SE<- db$SD/sqrt(length(unique(FD$sub)))

db$Sound<- factor(db$Sound, levels= c("Silence", "Standard", "Deviant"))

limits <- aes(ymax = db$Mean + db$SE, ymin=db$Mean - db$SE)

Dplot<- ggplot(data= db, aes(x=Sound, y= Mean, color=Measure, fill= Measure, group= Measure, shape= Measure, linetype= Measure))+ 
  scale_fill_brewer(palette="Dark2")+ 
  scale_colour_brewer(palette="Dark2")+
  #scale_fill_manual(values=c(ColorBlind[6:7]))+
  #scale_colour_manual(values=c(ColorBlind[6:7]))+
  theme_bw() + theme(panel.grid.major = element_line(colour = "#E3E5E6", size=0.7), 
                     axis.line = element_line(colour = "black", size=1),
                     panel.border = element_rect(colour = "black", size=1, fill = NA))+
  geom_line(size=2)+
  geom_point(size=7)+ 
  xlab("\n Background sound")+ ylab("Mean fixation duration (in ms)")+ 
  theme(legend.position= c(.11, .85), legend.title=element_text(size=20,
        face="bold", family="serif"),
        legend.text=element_text(size=20,family="serif"),legend.key.width=unit(2,"cm"),
        legend.key.height=unit(1,"cm"), strip.text=element_text(size=20, family="serif"),
        title=element_text(size=20, family="serif"),
        axis.title.x = element_text(size=20, face="bold", family="serif"),
        axis.title.y = element_text(size=20, face="bold", family="serif"), 
        axis.text=element_text(size=20, family="serif"), 
        panel.border = element_rect(linetype = "solid", colour = "black"), 
        legend.key = element_rect(colour = "#000000", size=1))+
  geom_ribbon(limits, alpha=0.1, colour=NA)

```

```{r, echo=FALSE, fig.height= 7, fig.width=9}
Dplot

```
FFD: First fixation duration. GD: gaze duration (the sum of all fixations before moving on to another word). TVT: Total viewing time (the sum of all fixations, including the ones made during a regression).
